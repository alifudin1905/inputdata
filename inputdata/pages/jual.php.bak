<?php
include_once __DIR__ . '/../includes/db.php';
include_once __DIR__ . '/../includes/header.php';
session_start();

if (!isset($_SESSION['cart'])) {
    $_SESSION['cart'] = [];
}

// Step 1: Pilih karyawan dan isi nomor nota
if (isset($_POST['set_karyawan_nota'])) {
    $_SESSION['id_karyawan'] = isset($_POST['id_karyawan']) ? trim($_POST['id_karyawan']) : '';
    if (!isset($_SESSION['last_nota'])) $_SESSION['last_nota'] = [];
    if (isset($_POST['nomor_nota']) && trim($_POST['nomor_nota']) !== '') {
        $input_nota = trim($_POST['nomor_nota']);
        // Cek duplikasi nomor nota untuk karyawan ini
        $stmt = $pdo->prepare("SELECT COUNT(*) as cnt FROM penjualan WHERE id_karyawan = ? AND nomor_nota = ?");
        $stmt->execute([$_SESSION['id_karyawan'], $input_nota]);
        $is_duplicate = $stmt->fetch()['cnt'] > 0;
        if ($is_duplicate) {
            $_SESSION['error'] = "Nomor nota sudah digunakan untuk karyawan ini. Silakan pilih nomor lain.";
            header("Location: jual.php");
            exit;
        }
        $_SESSION['nomor_nota'] = $input_nota;
        $_SESSION['last_nota'][$_SESSION['id_karyawan']] = $_SESSION['nomor_nota'];
    } else if ($_SESSION['id_karyawan'] !== '') {
        if (isset($_SESSION['last_nota'][$_SESSION['id_karyawan']])) {
            $_SESSION['nomor_nota'] = $_SESSION['last_nota'][$_SESSION['id_karyawan']];
        } else {
            $stmt = $pdo->prepare("SELECT MAX(CAST(nomor_nota AS UNSIGNED)) as max_nota FROM penjualan WHERE id_karyawan = ?");
            $stmt->execute([$_SESSION['id_karyawan']]);
            $max_nota = $stmt->fetch()['max_nota'];
            $next_nota = ($max_nota !== null && $max_nota !== '') ? ((int)$max_nota + 1) : 1;
            $_SESSION['nomor_nota'] = $next_nota;
            $_SESSION['last_nota'][$_SESSION['id_karyawan']] = $_SESSION['nomor_nota'];
        }
    }
    header("Location: jual.php");
    exit;
}

// Step 2: Tambah item ke cart (PERBAIKAN DI SINI)
if (isset($_POST['add_item'])) {
    if (!empty($_POST['nama_barang']) && $_POST['qty'] !== '' && $_POST['harga'] !== '') {
        // Bersihkan harga dari format ribuan
        $harga_clean = str_replace('.', '', $_POST['harga']);
        $harga = (float)$harga_clean;
        
        $item = [
            'nama_barang' => $_POST['nama_barang'],
            'qty' => (int)$_POST['qty'],
            'harga' => $harga,
            'subtotal' => (int)$_POST['qty'] * $harga
        ];
        $_SESSION['cart'][] = $item;
    }
    header("Location: jual.php");
    exit;
}

// Hapus item dari cart
if (isset($_GET['remove'])) {
    if (isset($_SESSION['cart'][$_GET['remove']])) {
        unset($_SESSION['cart'][$_GET['remove']]);
        $_SESSION['cart'] = array_values($_SESSION['cart']);
    }
    header("Location: jual.php");
    exit;
}

// Proses penjualan (PERBAIKAN DI SINI)
if (isset($_POST['submit_penjualan'])) {
    if (empty($_SESSION['cart'])) {
        $_SESSION['error'] = "Cart tidak boleh kosong!";
        header("Location: jual.php");
        exit;
    }
    // Validasi input wajib
    $nomor_nota = isset($_POST['nomor_nota']) ? trim($_POST['nomor_nota']) : (isset($_SESSION['nomor_nota']) ? $_SESSION['nomor_nota'] : '');
    $id_karyawan = isset($_POST['id_karyawan']) ? trim($_POST['id_karyawan']) : (isset($_SESSION['id_karyawan']) ? $_SESSION['id_karyawan'] : '');
    
    // Bersihkan tunai dan transfer dari format ribuan
    $tunai = isset($_POST['tunai']) ? str_replace('.', '', $_POST['tunai']) : 0;
    $tunai = (float)$tunai;
    $transfer = isset($_POST['transfer']) ? str_replace('.', '', $_POST['transfer']) : 0;
    $transfer = (float)$transfer;
    
    if ($nomor_nota === '' || $id_karyawan === '') {
        $_SESSION['error'] = "Nomor nota dan karyawan wajib diisi!";
        header("Location: jual.php");
        exit;
    }
    $stmt = $pdo->prepare("INSERT INTO penjualan (nomor_nota, id_karyawan, tunai, transfer) VALUES (?, ?, ?, ?)");
    $stmt->execute([
        $nomor_nota,
        $id_karyawan,
        $tunai,
        $transfer
    ]);
    $id_penjualan = $pdo->lastInsertId();
    foreach ($_SESSION['cart'] as $item) {
        $stmt = $pdo->prepare("INSERT INTO detail_penjualan (id_penjualan, nama_barang, qty, harga) VALUES (?, ?, ?, ?)");
        $stmt->execute([$id_penjualan, $item['nama_barang'], $item['qty'], $item['harga']]);
    }
    // Setelah transaksi, update nomor nota berikutnya untuk karyawan ini
    if (!isset($_SESSION['last_nota'])) $_SESSION['last_nota'] = [];
    $next_nota = is_numeric($nomor_nota) ? ((int)$nomor_nota + 1) : $nomor_nota;
    $_SESSION['last_nota'][$id_karyawan] = $next_nota;
    $_SESSION['nomor_nota'] = $next_nota;
    $_SESSION['id_karyawan'] = $id_karyawan;
    $_SESSION['cart'] = [];
    $_SESSION['success'] = "Penjualan berhasil disimpan!";
    header("Location: jual.php");
    exit;
}

// Hitung total pendapatan hari ini
$today = date('Y-m-d');
$stmt = $pdo->prepare("SELECT SUM(tunai) as total_tunai, SUM(transfer) as total_transfer FROM penjualan WHERE DATE(tanggal) = ?");
$stmt->execute([$today]);
$row = $stmt->fetch();
$total_tunai = $row['total_tunai'] ?? 0;
$total_transfer = $row['total_transfer'] ?? 0;
$total_pendapatan = $total_tunai + $total_transfer;
?>


<div class="container">
    <header style="position:sticky;top:0;z-index:100;background:#fff;padding-top:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
        <h1>Input Penjualan</h1>
        <div class="info-pendapatan card" style="margin-bottom:18px;">
            <!-- PERBAIKAN FORMAT ANGKA DI SINI -->
            <span style="margin-right:18px;"><b>Uang Tunai:</b> Rp <?= number_format($total_tunai, 0, ',', '.') ?></span>
            <span style="margin-right:18px;"><b>Transfer:</b> Rp <?= number_format($total_transfer, 0, ',', '.') ?></span>
            <span><b>Total:</b> Rp <?= number_format($total_pendapatan, 0, ',', '.') ?></span>
        </div>
    </header>

    <!-- Step 1: Header transaksi -->
    <?php if (isset($_SESSION['id_karyawan']) && isset($_SESSION['nomor_nota']) && $_SESSION['id_karyawan'] !== '' && $_SESSION['nomor_nota'] !== ''): ?>
        <div class="card" style="max-width:600px;margin:24px 0 18px 0;">
            <b>Karyawan:</b> <?php
                $stmt = $pdo->prepare("SELECT nama FROM karyawan WHERE id = ?");
                $stmt->execute([$_SESSION['id_karyawan']]);
                echo htmlspecialchars($stmt->fetchColumn());
            ?> |
            <b>Nomor Nota:</b> <?= htmlspecialchars($_SESSION['nomor_nota']) ?>
            <a href="jual.php?reset=1" class="btn btn-negative" style="margin-left:16px;font-size:0.95em;" onclick="return confirm('Reset transaksi penjualan?')">Reset</a>
        </div>
    <?php endif; ?>

    <?php if (isset($_SESSION['error'])): ?>
        <div class="error"><?= $_SESSION['error'] ?></div>
        <?php unset($_SESSION['error']); ?>
    <?php endif; ?>
    <?php if (isset($_SESSION['success'])): ?>
        <div class="success"><?= $_SESSION['success'] ?></div>
        <?php unset($_SESSION['success']); ?>
    <?php endif; ?>

    <!-- Step 1: Form Pilih Karyawan & Nomor Nota -->
    <?php if (!isset($_SESSION['id_karyawan']) || !isset($_SESSION['nomor_nota']) || $_SESSION['id_karyawan'] === '' || $_SESSION['nomor_nota'] === ''): ?>
        <div class="card" style="max-width:500px;margin:32px 0 32px 0;">
            <form method="post" action="" id="form-karyawan-nota">
                <label>Karyawan:
                    <select name="id_karyawan" id="id_karyawan_select" required>
                        <option value="">-- Pilih Karyawan --</option>
                        <?php
                        $stmt = $pdo->query("SELECT * FROM karyawan ORDER BY nama");
                        $selected_id = isset($_SESSION['id_karyawan']) ? $_SESSION['id_karyawan'] : '';
                        foreach ($stmt as $k) {
                            $selected = ($selected_id == $k['id']) ? 'selected' : '';
                            echo "<option value='{$k['id']}' $selected>{$k['nama']}</option>";
                        }
                        ?>
                    </select>
                </label>
                <label>Nomor Nota:
                    <input type="text" name="nomor_nota" id="nomor_nota_input" value="<?= isset($_SESSION['nomor_nota']) ? htmlspecialchars($_SESSION['nomor_nota']) : '' ?>" required>
                </label>
                <button type="submit" name="set_karyawan_nota" class="btn btn-primary">Lanjut</button>
            </form>
            <div id="nomor-nota-aktif-info" style="margin-top:5px;font-size:13px;font-weight:bold;opacity:0.7;">
                <?php if (isset($_SESSION['nomor_nota']) && $_SESSION['nomor_nota'] !== ''): ?>
                    Nomor Nota Aktif: <?= htmlspecialchars($_SESSION['nomor_nota']) ?>
                <?php endif; ?>
            </div>
        </div>
    <script>
    // Data last_nota per karyawan dari PHP ke JS
    var lastNota = <?php echo json_encode(isset($_SESSION['last_nota']) ? $_SESSION['last_nota'] : []); ?>;
    var nomorNotaInput = document.getElementById('nomor_nota_input');
    var karyawanSelect = document.getElementById('id_karyawan_select');
    var infoNotaAktif = document.getElementById('nomor-nota-aktif-info');
    karyawanSelect.addEventListener('change', function() {
        var id = this.value;
        if (id && lastNota[id]) {
            nomorNotaInput.value = lastNota[id];
            infoNotaAktif.textContent = 'Nomor Nota Aktif: ' + lastNota[id];
        } else if (id) {
            // Jika belum ada, fetch ke server (AJAX) untuk nomor nota berikutnya
            fetch('get_next_nota.php?id_karyawan=' + encodeURIComponent(id))
                .then(resp => resp.json())
                .then(data => {
                    nomorNotaInput.value = data.next_nota;
                    infoNotaAktif.textContent = 'Nomor Nota Aktif: ' + data.next_nota;
                });
        } else {
            nomorNotaInput.value = '';
            infoNotaAktif.textContent = '';
        }
    });
    </script>
    <?php endif; ?>

    <!-- Step 2: Form Tambah Barang, hanya jika karyawan & nota sudah diisi -->
    <?php if (isset($_SESSION['nomor_nota']) && isset($_SESSION['id_karyawan']) && $_SESSION['nomor_nota'] !== '' && $_SESSION['id_karyawan'] !== ''): ?>
        <div class="card" style="max-width:600px;margin:24px 0 18px 0;">
            <form method="post" action="" id="form-barang">
                <label>Nama Barang:
                    <input type="text" name="nama_barang" id="input-nama-barang" required>
                </label>
                <label>Jumlah:
                    <input type="number" name="qty" value="1" required>
                </label>
                <label>Harga:
                    <input type="text" name="harga" id="input-harga" required oninput="this.value=formatRupiah(this.value)">
                </label>
                <button type="submit" name="add_item" class="btn btn-primary">Tambah ke Cart</button>
            </form>
        </div>
    <script>
    // Fokus otomatis ke input nama barang setelah reload (tambah ke cart)
    window.addEventListener('DOMContentLoaded', function() {
        var inputNama = document.getElementById('input-nama-barang');
        if (inputNama) inputNama.focus();
    });
    </script>
    <?php endif; ?>

    <!-- Cart Belanja -->
    <div class="cart-container card" style="max-width:700px;margin:0 0 18px 0;">
        <h2>Keranjang Belanja</h2>
        <?php
        $total_cart = 0;
        if (!empty($_SESSION['cart'])): ?>
            <table class="tabel-data">
                <thead>
                    <tr><th>Nama Barang</th><th>Qty</th><th>Harga</th><th>Subtotal</th><th>Aksi</th></tr>
                </thead>
                <tbody>
                <?php foreach ($_SESSION['cart'] as $index => $item):
                    $total_cart += $item['subtotal']; ?>
                    <tr>
                        <td><?= htmlspecialchars($item['nama_barang']) ?></td>
                        <td><?= $item['qty'] ?></td>
                        <!-- PERBAIKAN FORMAT ANGKA DI SINI -->
                        <td><?= number_format($item['harga'], 0, ',', '.') ?></td>
                        <td><?= number_format($item['subtotal'], 0, ',', '.') ?></td>
                        <td><a href="jual.php?remove=<?= $index ?>" class="btn btn-negative" onclick="return confirm('Hapus item ini?')">Hapus</a></td>
                    </tr>
                <?php endforeach; ?>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" style="text-align:left;font-size:0.98em;">
                            <b>Jumlah Nota:</b> <?= count($_SESSION['cart']) ?> |
                            <b>Total Qty:</b> <?= array_sum(array_column($_SESSION['cart'], 'qty')) ?> |
                            <b>Total Barang:</b> <?= count(array_unique(array_column($_SESSION['cart'], 'nama_barang'))) ?>
                        </td>
                    </tr>
                    <!-- PERBAIKAN FORMAT ANGKA DI SINI -->
                    <tr><th colspan="3">Total</th><th colspan="2"><?= number_format($total_cart, 0, ',', '.') ?></th></tr>
                </tfoot>
            </table>
            <div class="success" style="margin-top:10px;font-size:1.12em;max-width:340px;">
                <!-- PERBAIKAN FORMAT ANGKA DI SINI -->
                <b>Total Belanja:</b> <?= number_format($total_cart, 0, ',', '.') ?>
            </div>
        <?php else: ?>
            <p>Keranjang belanja kosong</p>
        <?php endif; ?>
    </div>

    <!-- Form Pembayaran, hanya jika cart terisi dan karyawan/nota sudah diisi -->
    <?php if (!empty($_SESSION['cart']) && isset($_SESSION['nomor_nota']) && isset($_SESSION['id_karyawan']) && $_SESSION['nomor_nota'] !== '' && $_SESSION['id_karyawan'] !== ''): ?>
    <form method="post" action="" id="form-pembayaran">
        <input type="hidden" name="nomor_nota" value="<?= htmlspecialchars($_SESSION['nomor_nota']) ?>">
        <input type="hidden" name="id_karyawan" value="<?= htmlspecialchars($_SESSION['id_karyawan']) ?>">
        <div class="payment-section card">
            <h2>Pembayaran</h2>
            <label>Tunai (boleh minus):
                <input type="text" name="tunai" id="input-tunai" value="<?= isset($_POST['tunai']) ? htmlspecialchars($_POST['tunai']) : '0' ?>" oninput="this.value=formatRupiah(this.value)">
            </label>
            <label>Transfer (boleh minus):
                <input type="text" name="transfer" id="input-transfer" value="<?= isset($_POST['transfer']) ? htmlspecialchars($_POST['transfer']) : '0' ?>" oninput="this.value=formatRupiah(this.value)">
            </label>
            <button type="submit" name="submit_penjualan" class="btn btn-primary">Simpan Penjualan</button>
        </div>
    </form>
    <?php endif; ?>
</div>

<script>
// PERBAIKAN FUNGSI FORMAT RUPIAH DI SINI
function formatRupiah(angka) {
    // Handle minus
    let isNegative = false;
    if (angka.startsWith('-')) {
        isNegative = true;
        angka = angka.substring(1);
    }
    
    let number_string = angka.replace(/[^\d]/g, '').toString();
    let sisa = number_string.length % 3;
    let rupiah = number_string.substr(0, sisa);
    let ribuan = number_string.substr(sisa).match(/\d{3}/g);
        
    if (ribuan) {
        let separator = sisa ? '.' : '';
        rupiah += separator + ribuan.join('.');
    }
    
    return isNegative ? '-' + rupiah : rupiah;
}

// Shortcut: F1 atau Ctrl+B untuk fokus ke input tunai pada form pembayaran
document.addEventListener('keydown', function(e) {
    // F1
    if (e.key === 'F1') {
        var inputTunai = document.getElementById('input-tunai');
        if (inputTunai) {
            e.preventDefault();
            inputTunai.focus();
        }
    }
    // Ctrl+B
    if ((e.ctrlKey || e.metaKey) && (e.key === 'b' || e.key === 'B')) {
        var inputTunai = document.getElementById('input-tunai');
        if (inputTunai) {
            e.preventDefault();
            inputTunai.focus();
        }
    }
});
</script>

<?php include_once __DIR__ . '/../includes/footer.php'; ?>